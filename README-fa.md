# معماری میکروسرویس آماده پروداکشن با NestJS

این پروژه یک معماری میکروسرویس قوی، مقیاس‌پذیر و آماده برای استقرار (Production-Ready) است که با استفاده از فریم‌ورک [NestJS](https://nestjs.com/) ساخته شده است. هدف این پروژه، فراهم کردن یک پایه و اساس (Boilerplate) کامل برای توسعه سریع اپلیکیشن‌های پیچیده است، به طوری که تمام زیرساخت‌های ضروری از پیش پیاده‌سازی شده باشند.

این معماری شامل ارتباط ناهمزمان بین سرویس‌ها از طریق **Redis**، ذخیره‌سازی داده با **MongoDB**، و یک **API Gateway** به عنوان نقطه ورود متمرکز است.

## ✨ ویژگی‌های کلیدی (Core Features)

این پروژه فقط یک اپلیکیشن ساده نیست، بلکه یک چارچوب کامل با ویژگی‌های زیر است:

- \*\* معماری میکروسرویس:\*\* جداسازی کامل منطق برنامه به سرویس‌های مستقل (`users-service`, `auth-service`) برای حداکثر مقیاس‌پذیری و قابلیت نگهداری.
- \*\* ارتباط ناهمزمان:\*\* استفاده از **Redis** به عنوان یک Message Broker قدرتمند برای ارتباط پایدار و ناهمزمان بین سرویس‌ها.
- \*\* الگوی API Gateway:\*\* یک نقطه ورود واحد (`api-gateway`) که مسئولیت مسیریابی، اعتبارسنجی اولیه و توزیع درخواست‌ها را بر عهده دارد.
- \*\* احراز هویت متمرکز و امن:\*\* یک سرویس اختصاصی `auth-service` که با استفاده از **JWT (JSON Web Tokens)** و مکانیزم `Passport.js`، وظیفه صدور و اعتبارسنجی توکن‌ها را به صورت ایزوله انجام می‌دهد.
- \*\* Rate Limiting پیشرفته و داینامیک:\*\*
    - یک گارد سراسری و هوشمند که به صورت خودکار بین کاربران لاگین کرده (بر اساس User ID) و کاربران مهمان (بر اساس IP) تمایز قائل می‌شود.
    - قابلیت تعریف چندین قانون همزمان برای هر مسیر (مثلاً محدودیت در ثانیه و محدودیت در دقیقه).
    - قابلیت تعریف محدودیت‌های داینامیک بر اساس پلن کاربر (مثلاً `free` در مقابل `premium`) که از توکن JWT خوانده می‌شود.
- \*\* لاگینگ ساختاریافته و جامع:\*\* استفاده از **Winston** برای ثبت لاگ‌های آماده پروداکشن با فرمت JSON، همراه با یک `LoggingInterceptor` که تمام جزئیات درخواست‌ها و پاسخ‌ها را به صورت خودکار ثبت می‌کند.
- \*\* مدیریت خطای متمرکز:\*\* یک `AllExceptionsFilter` سراسری که تمام خطاهای برنامه (چه HTTP و چه خطاهای داخلی میکروسرویس‌ها یا `RpcException`) را به صورت یکپارچه دریافت کرده و یک پاسخ استاندارد و قابل فهم برمی‌گرداند.
- \*\* کتابخانه اشتراکی (`libs/common`):\*\* برای جلوگیری از تکرار کد و اشتراک‌گذاری ماژول‌ها، DTOها، گاردها و ابزارهای مشترک بین تمام سرویس‌ها.
- \*\* پیکربندی مبتنی بر محیط:\*\* استفاده از فایل‌های `.env` مجزا برای هر سرویس و اعتبارسنجی آن‌ها با `Joi` برای جلوگیری از اجرای برنامه با تنظیمات ناقص.
- \*\* کاملاً داکرسازی شده:\*\* تمام معماری (شامل سرویس‌ها، MongoDB و Redis) با یک دستور `docker-compose up` به صورت کامل و یکپارچه اجرا می‌شود.

## 🏗️ نمای کلی معماری

```
+----------------+   (HTTP Request)   +-----------------+   (Message via Redis)   +------------------+   (CRUD)   +-----------+
|                | -----------------> |                 | ----------------------> |                  | <--------> |           |
|  Client (Web/  |                    |   API Gateway   |                         |   Users Service  |            |  MongoDB  |
|     Mobile)    | <----------------- |                 | <---------------------- |                  | <--------> |           |
|                |   (HTTP Response)  |                 |   (Response via Redis)  |------------------+            +-----------+
+----------------+                    +-------+---------+                         |                  |
                                            |                                   |   Auth Service   |
                                            | (Message via Redis)               |                  |
                                            +---------------------------------> +------------------+
```

## 🛠️ پشته فناوری (Tech Stack)

- **فریم‌ورک اصلی:** [NestJS](https://nestjs.com/)
- **زبان:** [TypeScript](https://www.typescriptlang.org/)
- **دیتابیس:** [MongoDB](https://www.mongodb.com/) (با استفاده از Mongoose)
- **مسیج بروکر:** [Redis](https://redis.io/)
- **کانتینرسازی:** [Docker](https://www.docker.com/) & Docker Compose
- **احراز هویت:** [Passport.js](http://www.passportjs.org/) (استراتژی JWT)
- **لاگینگ:** [Winston](https://github.com/winstonjs/winston)
- **اعتبارسنجی:** [Joi](https://joi.dev/) و `class-validator`

## 🚀 راه‌اندازی و اجرا

برای اجرای این پروژه به صورت محلی، به **Node.js (نسخه 18 یا بالاتر)** و **Docker** نیاز دارید.

**۱. شبیه‌سازی ریپازیتوری:**

```bash
git clone https://github.com/YOUR_USERNAME/YOUR_REPOSITORY.git
cd YOUR_REPOSITORY
```

**۲. نصب وابستگی‌ها:**

```bash
npm install
```

**۳. ایجاد فایل‌های متغیرهای محیطی (`.env`):**
شما باید سه فایل `.env` مجزا در مسیرهای مشخص شده ایجاد کنید.

- **`apps/api-gateway/.env`:**

    ```env
    API_GATEWAY_PORT=3000
    REDIS_HOST=redis
    REDIS_PORT=6379
    ```

- **`apps/users-service/.env`:**

    ```env
    USERS_SERVICE_PORT=3001
    REDIS_HOST=redis
    REDIS_PORT=6379
    USERS_DB_URI=mongodb://mongo:27017/users_db
    ```

- **`apps/auth-service/.env`:**

    ```env
    AUTH_SERVICE_PORT=3002
    REDIS_HOST=redis
    REDIS_PORT=6379
    JWT_SECRET=YOUR_SUPER_SECRET_KEY_CHANGE_IT
    JWT_EXPIRATION=3600s
    ```

**۴. اجرای کامل معماری با Docker Compose:**
این دستور تمام ایمیج‌ها را build کرده و تمام کانتینرها را اجرا می‌کند.

```bash
docker-compose up --build
```

پس از چند لحظه، تمام سرویس‌های شما باید در حال اجرا باشند.

## 🧪 تست و استفاده

می‌توانید از ابزاری مانند `curl` یا Postman برای تست اندپوینت‌ها استفاده کنید.

**۱. ثبت‌نام کاربر جدید:**

```bash
curl -X POST -H "Content-Type: application/json" \
-d '{"email":"test@example.com", "password":"StrongPassword123"}' \
http://localhost:3000/api/users/sign-up
```

**۲. لاگین با کاربر جدید:**

```bash
curl -X POST -H "Content-Type: application/json" \
-d '{"email":"test@example.com", "password":"StrongPassword123"}' \
http://localhost:3000/api/auth/login
```

در پاسخ، یک توکن `accessToken` دریافت خواهید کرد.

## 🗺️ نقشه راه و مراحل بعدی

- [ ] **نوشتن تست‌ها:** اضافه کردن تست‌های Unit، Integration و E2E.
- [ ] **تکمیل Rate Limiter:** پیاده‌سازی منطق سهمیه‌بندی ماهانه (`fixed window`).
- [ ] **افزودن سرویس‌های جدید:** اضافه کردن سرویس‌های بیشتر مانند محصولات یا سفارشات.
- [ ] **راه‌اندازی CI/CD:** ساخت پایپ‌لاین برای تست و بیلد خودکار.

## 📄 مجوز (License)

این پروژه تحت مجوز [MIT](https://www.google.com/search?q=LICENSE) منتشر شده است.
